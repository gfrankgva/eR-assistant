javascript:(function(){if(document.getElementById('bpa-w6')){return;}var s=document.createElement('style');s.textContent='#bpa-w6{position:fixed;top:0;right:-480px;width:480px;height:100vh;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,0.12);z-index:999999;transition:right 0.3s;border-left:1px solid #e0e0e0;font-family:system-ui}#bpa-w6.open{right:0}.bpa-hdr{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;color:#fff}.bpa-content{padding:20px;overflow-y:auto;height:calc(100vh - 80px);background:#fafafa}.bpa-section{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:16px;margin-bottom:12px}.bpa-upload{border:2px dashed #d0d0d0;border-radius:8px;padding:24px;text-align:center;cursor:pointer;background:#fafafa}.health-item{display:flex;justify-content:space-between;padding:10px;background:#f8f8f8;border-radius:6px;border-left:3px solid #e0e0e0;margin-bottom:8px;font-size:13px}.health-item.ok{border-left-color:#10b981;background:#f0fdf4}.health-item.bad{border-left-color:#ef4444;background:#fef2f2}.health-item.warn{border-left-color:#f59e0b;background:#fffbeb}.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0}.stat-card{background:#f6f8fb;padding:14px;border-radius:8px;text-align:center}.stat-val{font-size:24px;font-weight:700;color:#667eea}.stat-lbl{font-size:11px;color:#666;margin-top:4px}.bot-type-item{display:flex;justify-content:space-between;padding:10px 12px;background:#f8f8f8;border-radius:6px;font-size:12px;margin-bottom:8px}.btn-analyze{width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:12px}';document.head.appendChild(s);var w=document.createElement('div');w.id='bpa-w6';w.innerHTML='<div class="bpa-hdr"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:18px;font-weight:600">üîç BPA Analyzer</div><div style="font-size:12px;opacity:0.9">Phase 2 Complete</div></div><button onclick="this.closest(\'#bpa-w6\').classList.remove(\'open\')" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:16px">√ó</button></div></div><div class="bpa-content"><div class="bpa-section"><div style="font-weight:600;margin-bottom:12px">üì§ Upload JSON</div><div class="bpa-upload" onclick="document.getElementById(\'bpa-f6\').click()"><div style="font-size:28px;margin-bottom:8px">üìÑ</div><div style="font-size:13px;color:#666">Click to upload</div></div><input type="file" id="bpa-f6" accept=".json" style="display:none"><div id="bpa-fname6" style="display:none;margin-top:10px;padding:10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:12px;color:#166534"></div></div><div id="bpa-overview6" style="display:none" class="bpa-section"><div style="font-weight:600;margin-bottom:12px">üìä Overview</div><div class="stat-grid"><div class="stat-card"><div class="stat-val" id="bpa-bots6">0</div><div class="stat-lbl">BOTs</div></div><div class="stat-card"><div class="stat-val" id="bpa-acts6">0</div><div class="stat-lbl">Actions</div></div><div class="stat-card"><div class="stat-val" id="bpa-dets6">0</div><div class="stat-lbl">Determinants</div></div></div><div id="bpa-breakdown6"></div></div><div id="bpa-health6" style="display:none" class="bpa-section"><div style="font-weight:600;margin-bottom:12px">üè• Health Check</div><div id="bpa-health-list6"></div><button class="btn-analyze" onclick="window.runBpaAnalysis6()">üî¨ Run Full Analysis</button></div><div id="bpa-analysis6" style="display:none" class="bpa-section"><div style="font-weight:600;margin-bottom:12px">üìã Analysis</div><div id="bpa-results6"></div></div></div>';document.body.appendChild(w);var t=document.createElement('button');t.style.cssText='position:fixed;right:0;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;width:40px;height:100px;border-radius:8px 0 0 8px;cursor:pointer;font-size:12px;font-weight:600;writing-mode:vertical-rl;z-index:999998;box-shadow:-2px 2px 12px rgba(0,0,0,0.15)';t.textContent='BPA';t.onclick=function(){w.classList.toggle('open');t.style.display=w.classList.contains('open')?'none':'block'};document.body.appendChild(t);var svcData=null;function extractKeys(cs){var ks=new Set();function trav(cps){if(!Array.isArray(cps))return;cps.forEach(function(c){if(c.key)ks.add(c.key);if(c.components)trav(c.components);if(c.columns)c.columns.forEach(function(cl){if(cl.components)trav(cl.components)})})}trav(cs);return ks}function extractDetIds(obj,ids){if(!obj)return;if(Array.isArray(obj)){obj.forEach(function(i){extractDetIds(i,ids)})}else if(typeof obj==='object'){if(obj.determinantId)ids.add(obj.determinantId);Object.values(obj).forEach(function(v){extractDetIds(v,ids)})}}document.getElementById('bpa-f6').onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var raw=JSON.parse(ev.target.result);svcData=raw.service||raw;var b=svcData.bots||[];var ca=svcData.componentActions||[];var dets=svcData.serviceDeterminants||[];document.getElementById('bpa-fname6').style.display='block';document.getElementById('bpa-fname6').textContent='‚úÖ '+f.name+' ('+Math.round(f.size/1024)+'KB)';document.getElementById('bpa-bots6').textContent=b.length;document.getElementById('bpa-acts6').textContent=ca.length;document.getElementById('bpa-dets6').textContent=dets.length;var btypes={data:0,document:0,message:0,system:0};b.forEach(function(bot){var t=bot.botType||'system';if(btypes[t]!==undefined)btypes[t]++});var bdhtml='<div style="font-size:12px;color:#666;margin-bottom:8px;font-weight:600">BOTs by Type</div>';if(btypes.data>0)bdhtml+='<div class="bot-type-item"><span>ü§ñ Data</span><span>'+btypes.data+'</span></div>';if(btypes.document>0)bdhtml+='<div class="bot-type-item"><span>üìÑ Document</span><span>'+btypes.document+'</span></div>';if(btypes.message>0)bdhtml+='<div class="bot-type-item"><span>‚úâÔ∏è Message</span><span>'+btypes.message+'</span></div>';if(btypes.system>0)bdhtml+='<div class="bot-type-item"><span>‚öôÔ∏è System</span><span>'+btypes.system+'</span></div>';document.getElementById('bpa-breakdown6').innerHTML=bdhtml;var fkeys=new Set();try{if(svcData.applicantFormPage&&svcData.applicantFormPage.formSchema){var fs=JSON.parse(svcData.applicantFormPage.formSchema);fkeys=extractKeys(fs.components||[])}}catch(err){}var used=new Set();ca.forEach(function(act){var rows=act.actionRows||[];rows.forEach(function(row){var bots=row.bots||[];bots.forEach(function(bot){if(bot.name)used.add(bot.name)})})});var unused=b.filter(function(bot){return!used.has(bot.name)}).length;var broken=dets.filter(function(d){return d.determinantType==='FORMFIELD'&&d.targetFormFieldKey&&!fkeys.has(d.targetFormFieldKey)}).length;var usedDetIds=new Set();var behs=svcData.componentBehaviours||[];behs.forEach(function(beh){var effs=beh.effects||[];effs.forEach(function(eff){try{var jd=JSON.parse(eff.jsonDeterminants||'[]');extractDetIds(jd,usedDetIds)}catch(err){}})});b.forEach(function(bot){var maps=bot.dataMappings||[];maps.forEach(function(m){if(m.jsonDeterminant){try{var jd=JSON.parse(m.jsonDeterminant);extractDetIds(jd,usedDetIds)}catch(err){}}})});var unusedDets=dets.filter(function(d){return!usedDetIds.has(d.oldId)}).length;var h='';h+='<div class="health-item '+(unused===0?'ok':'warn')+'"><span>'+(unused===0?'‚úÖ':'üóëÔ∏è')+' Unused BOTs</span><span>'+unused+'/'+b.length+'</span></div>';h+='<div class="health-item '+(broken===0?'ok':'bad')+'"><span>'+(broken===0?'‚úÖ':'üö®')+' Broken Determinants</span><span>'+broken+'</span></div>';h+='<div class="health-item '+(unusedDets===0?'ok':'warn')+'"><span>'+(unusedDets===0?'‚úÖ':'‚ö†Ô∏è')+' Unused Determinants</span><span>'+unusedDets+'</span></div>';document.getElementById('bpa-health-list6').innerHTML=h;document.getElementById('bpa-overview6').style.display='block';document.getElementById('bpa-health6').style.display='block'}catch(err){alert('Error: '+err.message)}};r.readAsText(f)};window.runBpaAnalysis6=function(){if(!svcData)return;var b=svcData.bots||[];var ca=svcData.componentActions||[];var dets=svcData.serviceDeterminants||[];var errs=[],warns=[];var fkeys=new Set();try{if(svcData.applicantFormPage&&svcData.applicantFormPage.formSchema){var fs=JSON.parse(svcData.applicantFormPage.formSchema);fkeys=extractKeys(fs.components||[])}}catch(err){}var bnames=new Set(b.map(function(x){return x.name}));var used=new Set();ca.forEach(function(act){var rows=act.actionRows||[];rows.forEach(function(row){var bots=row.bots||[];bots.forEach(function(bot){if(bot.name){used.add(bot.name);if(!bnames.has(bot.name)){errs.push({type:'Undefined BOT',message:'Action "'+act.componentKey+'" uses undefined BOT "'+bot.name+'"'})}}})})});b.forEach(function(bot){if(!used.has(bot.name)){warns.push({type:'Unused BOT',message:'BOT "'+bot.name+'" ('+bot.botType+') never used'})}});var detIds=new Set(dets.map(function(d){return d.oldId}));var usedDetIds=new Set();var behs=svcData.componentBehaviours||[];behs.forEach(function(beh){var effs=beh.effects||[];effs.forEach(function(eff){try{var jd=JSON.parse(eff.jsonDeterminants||'[]');extractDetIds(jd,usedDetIds)}catch(err){}})});b.forEach(function(bot){var maps=bot.dataMappings||[];maps.forEach(function(m){if(m.jsonDeterminant){try{var jd=JSON.parse(m.jsonDeterminant);extractDetIds(jd,usedDetIds)}catch(err){}}})});usedDetIds.forEach(function(id){if(!detIds.has(id)){errs.push({type:'Undefined Determinant',message:'Determinant ID "'+id.substring(0,8)+'..." referenced but not defined'})}});dets.forEach(function(d){if(d.determinantType==='FORMFIELD'&&d.targetFormFieldKey&&!fkeys.has(d.targetFormFieldKey)){errs.push({type:'Broken Determinant',message:'Determinant "'+d.name+'" references missing field "'+d.targetFormFieldKey+'"'})}});dets.forEach(function(d){if(!usedDetIds.has(d.oldId)){warns.push({type:'Unused Determinant',message:'Determinant "'+d.name+'" defined but never used'})}});var sc=100-errs.length*10-warns.length*2;sc=Math.max(0,Math.min(100,sc));var html='<div style="margin-bottom:20px"><span style="display:inline-flex;padding:8px 16px;border-radius:20px;font-weight:600;font-size:14px;background:'+(sc>=90?'#dcfce7':sc>=70?'#dbeafe':sc>=50?'#fef3c7':'#fee2e2')+';color:'+(sc>=90?'#166534':sc>=70?'#1e40af':sc>=50?'#92400e':'#991b1b')+'">'+sc+'/100 '+(sc>=90?'Excellent':sc>=70?'Good':sc>=50?'Fair':'Poor')+'</span></div>';if(errs.length>0){html+='<div style="margin-bottom:16px"><div style="padding:10px 12px;background:#fef2f2;color:#b91c1c;border-radius:6px;margin-bottom:8px;font-weight:600;font-size:13px">üö® '+errs.length+' Error'+(errs.length>1?'s':'')+'</div>';errs.slice(0,5).forEach(function(e){html+='<div style="padding:12px;background:#fff;border:1px solid #e5e5e5;border-left:3px solid #ef4444;border-radius:6px;margin-bottom:8px;font-size:13px"><div style="font-weight:600;margin-bottom:4px">'+e.type+'</div><div style="color:#666">'+e.message+'</div></div>'});if(errs.length>5)html+='<div style="padding:12px;text-align:center;color:#666;font-size:12px">+ '+(errs.length-5)+' more</div>';html+='</div>'}if(warns.length>0){html+='<div><div style="padding:10px 12px;background:#fffbeb;color:#b45309;border-radius:6px;margin-bottom:8px;font-weight:600;font-size:13px">‚ö†Ô∏è '+warns.length+' Warning'+(warns.length>1?'s':'')+'</div>';warns.slice(0,5).forEach(function(w){html+='<div style="padding:12px;background:#fff;border:1px solid #e5e5e5;border-left:3px solid #f59e0b;border-radius:6px;margin-bottom:8px;font-size:13px"><div style="font-weight:600;margin-bottom:4px">'+w.type+'</div><div style="color:#666">'+w.message+'</div></div>'});if(warns.length>5)html+='<div style="padding:12px;text-align:center;color:#666;font-size:12px">+ '+(warns.length-5)+' more</div>';html+='</div>'}if(errs.length===0&&warns.length===0){html='<div style="text-align:center;padding:40px 20px;color:#999"><div style="font-size:48px;margin-bottom:16px;opacity:0.5">‚ú®</div><div style="font-size:14px"><strong>Service looks great!</strong><br>No errors or warnings found.</div></div>'}document.getElementById('bpa-results6').innerHTML=html;document.getElementById('bpa-analysis6').style.display='block'};console.log('‚úÖ BPA Phase 2 Complete loaded')})();
